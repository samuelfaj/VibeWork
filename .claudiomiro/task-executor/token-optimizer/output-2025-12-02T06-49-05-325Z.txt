# Token Optimizer Output
## Command
```
cd /Users/samuelfajreldines/Desenvolvimento/VibeWork/backend && npx vitest run modules/notifications/services/__tests__/notification-publisher.test.ts
```

## Output

[1m[46m RUN [49m[22m [36mv4.0.14 [39m[90m/Users/samuelfajreldines/Desenvolvimento/VibeWork/backend[39m

[90mstdout[2m | modules/notifications/services/__tests__/notification-publisher.test.ts[2m > [22m[2mNotification Publisher[2m > [22m[2mshould publish notification to correct topic
[22m[39m[NotificationPublisher] Published message message-id-123 to notification-created

[90mstdout[2m | modules/notifications/services/__tests__/notification-publisher.test.ts[2m > [22m[2mNotification Publisher[2m > [22m[2mshould serialize notification correctly
[22m[39m[NotificationPublisher] Published message message-id-123 to notification-created

[90mstdout[2m | modules/notifications/services/__tests__/notification-publisher.test.ts[2m > [22m[2mNotification Subscriber[2m > [22m[2mhandleMessage[2m > [22m[2mshould process email type and call EmailService
[22m[39m[NotificationSubscriber] Processing email notification: msg-123

[90mstdout[2m | modules/notifications/services/__tests__/notification-publisher.test.ts[2m > [22m[2mNotification Subscriber[2m > [22m[2mhandleMessage[2m > [22m[2mshould ignore in-app type and acknowledge
[22m[39m[NotificationSubscriber] Ignoring in-app notification: msg-456
[NotificationSubscriber] Message acknowledged: msg-456

[90mstdout[2m | modules/notifications/services/__tests__/notification-publisher.test.ts[2m > [22m[2mNotification Subscriber[2m > [22m[2mhandleMessage[2m > [22m[2mshould nack on EmailService error
[22m[39m[NotificationSubscriber] Processing email notification: msg-789

[90mstdout[2m | modules/notifications/services/__tests__/notification-publisher.test.ts[2m > [22m[2mNotification Subscriber[2m > [22m[2mstartNotificationSubscriber[2m > [22m[2mshould start subscriber and listen on subscription
[22m[39m[NotificationSubscriber] Listening on notification-created-sub

[90mstdout[2m | modules/notifications/services/__tests__/notification-publisher.test.ts[2m > [22m[2mNotification Subscriber[2m > [22m[2mstartNotificationSubscriber[2m > [22m[2mshould start subscriber and listen on subscription
[22m[39m[NotificationSubscriber] Subscriber stopped

[90mstdout[2m | modules/notifications/services/__tests__/notification-publisher.test.ts[2m > [22m[2mNotification Subscriber[2m > [22m[2mstopNotificationSubscriber[2m > [22m[2mshould stop subscriber and cleanup
[22m[39m[NotificationSubscriber] Listening on notification-created-sub

[90mstdout[2m | modules/notifications/services/__tests__/notification-publisher.test.ts[2m > [22m[2mNotification Subscriber[2m > [22m[2mstopNotificationSubscriber[2m > [22m[2mshould stop subscriber and cleanup
[22m[39m[NotificationSubscriber] Subscriber stopped

 [31mâ¯[39m modules/notifications/services/__tests__/notification-publisher.test.ts [2m([22m[2m12 tests[22m[2m | [22m[31m1 failed[39m[2m)[22m[32m 74[2mms[22m[39m
     [32mâœ“[39m should publish notification to correct topic[32m 28[2mms[22m[39m
     [32mâœ“[39m should serialize notification correctly[32m 1[2mms[22m[39m
       [32mâœ“[39m should return true for valid email payload[32m 19[2mms[22m[39m
       [32mâœ“[39m should return true for valid in-app payload[32m 2[2mms[22m[39m
       [32mâœ“[39m should return false for invalid type[32m 1[2mms[22m[39m
       [32mâœ“[39m should return false for missing fields[32m 1[2mms[22m[39m
[31m       [31mÃ—[31m should process email type and call EmailService[39m[32m 8[2mms[22m[39m
       [32mâœ“[39m should ignore in-app type and acknowledge[32m 1[2mms[22m[39m
       [32mâœ“[39m should nack on EmailService error[32m 2[2mms[22m[39m
       [32mâœ“[39m should ack invalid payload to prevent retry[32m 2[2mms[22m[39m
       [32mâœ“[39m should start subscriber and listen on subscription[32m 2[2mms[22m[39m
       [32mâœ“[39m should stop subscriber and cleanup[32m 5[2mms[22m[39m

[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m1 failed[39m[22m[2m | [22m[1m[32m11 passed[39m[22m[90m (12)[39m
[2m   Start at [22m 03:48:02
[2m   Duration [22m 380ms[2m (transform 129ms, setup 0ms, import 120ms, tests 74ms, environment 0ms)[22m

[90mstderr[2m | modules/notifications/services/__tests__/notification-publisher.test.ts[2m > [22m[2mNotification Subscriber[2m > [22m[2mhandleMessage[2m > [22m[2mshould process email type and call EmailService
[22m[39m[NotificationSubscriber] Error processing message msg-123: TypeError: Cannot read properties of null (reading 'sendEmail')
    at handleMessage [90m(/Users/samuelfajreldines/Desenvolvimento/VibeWork/backend/[39mmodules/notifications/services/notification-subscriber.ts:43:27[90m)[39m
    at [90m/Users/samuelfajreldines/Desenvolvimento/VibeWork/backend/[39mmodules/notifications/services/__tests__/notification-publisher.test.ts:161:13
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at file:///Users/samuelfajreldines/Desenvolvimento/VibeWork/node_modules/[4m@vitest[24m/runner/dist/index.js:919:20

[90mstderr[2m | modules/notifications/services/__tests__/notification-publisher.test.ts[2m > [22m[2mNotification Subscriber[2m > [22m[2mhandleMessage[2m > [22m[2mshould nack on EmailService error
[22m[39m[NotificationSubscriber] Error processing message msg-789: TypeError: Cannot read properties of null (reading 'sendEmail')
    at handleMessage [90m(/Users/samuelfajreldines/Desenvolvimento/VibeWork/backend/[39mmodules/notifications/services/notification-subscriber.ts:43:27[90m)[39m
    at [90m/Users/samuelfajreldines/Desenvolvimento/VibeWork/backend/[39mmodules/notifications/services/__tests__/notification-publisher.test.ts:221:13
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at file:///Users/samuelfajreldines/Desenvolvimento/VibeWork/node_modules/[4m@vitest[24m/runner/dist/index.js:919:20

[90mstderr[2m | modules/notifications/services/__tests__/notification-publisher.test.ts[2m > [22m[2mNotification Subscriber[2m > [22m[2mhandleMessage[2m > [22m[2mshould ack invalid payload to prevent retry
[22m[39m[NotificationSubscriber] Invalid payload, acking to prevent retry: msg-invalid


[31mâ¯â¯â¯â¯â¯â¯â¯[39m[1m[41m Failed Tests 1 [49m[22m[31mâ¯â¯â¯â¯â¯â¯â¯[39m

[41m[1m FAIL [22m[49m modules/notifications/services/__tests__/notification-publisher.test.ts[2m > [22mNotification Subscriber[2m > [22mhandleMessage[2m > [22mshould process email type and call EmailService
[31m[1mAssertionError[22m: expected "vi.fn()" to be called with arguments: [ 'user@example.com', â€¦(2) ][90m

Number of calls: [1m0[22m
[31m[39m
[36m [2mâ¯[22m modules/notifications/services/__tests__/notification-publisher.test.ts:[2m163:29[22m[39m
    [90m161| [39m      [35mawait[39m [34mhandleMessage[39m(message [35mas[39m any)
    [90m162| [39m
    [90m163| [39m      [34mexpect[39m(mockSendEmail)[33m.[39m[34mtoHaveBeenCalledWith[39m(
    [90m   | [39m                            [31m^[39m
    [90m164| [39m        [32m'user@example.com'[39m[33m,[39m
    [90m165| [39m        [32m'New Notification'[39m[33m,[39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/1]â¯[22m[39m


